!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e):e(CodeMirror)}(function(e){"use strict";function n(n,t,r){if(0>r&&0==t.ch)return n.clipPos(h(t.line-1));var o=n.getLine(t.line);if(r>0&&t.ch>=o.length)return n.clipPos(h(t.line+1,0));for(var i,a="start",l=t.ch,s=0>r?0:o.length,c=0;l!=s;l+=r,c++){var f=o.charAt(0>r?l-1:l),u="_"!=f&&e.isWordChar(f)?"w":"o";if("w"==u&&f.toUpperCase()==f&&(u="W"),"start"==a)"o"!=u&&(a="in",i=u);else if("in"==a&&i!=u){if("w"==i&&"W"==u&&0>r&&l--,"W"==i&&"w"==u&&r>0){i="w";continue}break}}return h(t.line,l)}function t(e,t){e.extendSelectionsBy(function(r){return e.display.shift||e.doc.extend||r.empty()?n(e.doc,r.head,t):0>t?r.from():r.to()})}function r(n,t){return n.isReadOnly()?e.Pass:void n.operation(function(){for(var e=n.listSelections().length,r=[],o=-1,i=0;e>i;i++){var a=n.listSelections()[i].head;if(!(a.line<=o)){var l=h(a.line+(t?0:1),0);n.replaceRange("\n",l,null,"+insertLine"),n.indentLine(l.line,null,!0),r.push({head:l,anchor:l}),o=a.line+1}}n.setSelections(r)})}function o(n,t){for(var r=t.ch,o=r,i=n.getLine(t.line);r&&e.isWordChar(i.charAt(r-1));)--r;for(;o<i.length&&e.isWordChar(i.charAt(o));)++o;return{from:h(t.line,r),to:h(t.line,o),word:i.slice(r,o)}}function i(e){var n=e.getCursor(),t=e.scanForBracket(n,-1);if(t)for(;;){var r=e.scanForBracket(n,1);if(!r)return;if(r.ch==g.charAt(g.indexOf(t.ch)+1))return e.setSelection(h(t.pos.line,t.pos.ch+1),r.pos,!1),!0;n=h(r.pos.line,r.pos.ch+1)}}function a(n,t){if(n.isReadOnly())return e.Pass;for(var r,o=n.listSelections(),i=[],a=0;a<o.length;a++){var l=o[a];if(!l.empty()){for(var s=l.from().line,c=l.to().line;a<o.length-1&&o[a+1].from().line==c;)c=l[++a].to().line;i.push(s,c)}}i.length?r=!0:i.push(n.firstLine(),n.lastLine()),n.operation(function(){for(var e=[],o=0;o<i.length;o+=2){var a=i[o],l=i[o+1],s=h(a,0),c=h(l),f=n.getRange(s,c,!1);t?f.sort():f.sort(function(e,n){var t=e.toUpperCase(),r=n.toUpperCase();return t!=r&&(e=t,n=r),n>e?-1:e==n?0:1}),n.replaceRange(f,s,c),r&&e.push({anchor:s,head:c})}r&&n.setSelections(e,0)})}function l(n,t){n.operation(function(){for(var r=n.listSelections(),i=[],a=[],l=0;l<r.length;l++){var s=r[l];s.empty()?(i.push(l),a.push("")):a.push(t(n.getRange(s.from(),s.to())))}n.replaceSelections(a,"around","case");for(var c,l=i.length-1;l>=0;l--){var s=r[i[l]];if(!(c&&e.cmpPos(s.head,c)>0)){var f=o(n,s.head);c=f.from,n.replaceRange(t(f.word),f.from,f.to)}}})}function s(n){var t=n.getCursor("from"),r=n.getCursor("to");if(0==e.cmpPos(t,r)){var i=o(n,t);if(!i.word)return;t=i.from,r=i.to}return{from:t,to:r,query:n.getRange(t,r),word:i}}function c(e,n){var t=s(e);if(t){var r=t.query,o=e.getSearchCursor(r,n?t.to:t.from);(n?o.findNext():o.findPrevious())?e.setSelection(o.from(),o.to()):(o=e.getSearchCursor(r,n?h(e.firstLine(),0):e.clipPos(h(e.lastLine()))),(n?o.findNext():o.findPrevious())?e.setSelection(o.from(),o.to()):t.word&&e.setSelection(t.from,t.to))}}var f=e.keyMap.sublime={fallthrough:"default"},u=e.commands,h=e.Pos,d=e.keyMap["default"]==e.keyMap.macDefault,p=d?"Cmd-":"Ctrl-";u[f["Alt-Left"]="goSubwordLeft"]=function(e){t(e,-1)},u[f["Alt-Right"]="goSubwordRight"]=function(e){t(e,1)};var m=d?"Ctrl-Alt-":"Ctrl-";u[f[m+"Up"]="scrollLineUp"]=function(e){var n=e.getScrollInfo();if(!e.somethingSelected()){var t=e.lineAtHeight(n.top+n.clientHeight,"local");e.getCursor().line>=t&&e.execCommand("goLineUp")}e.scrollTo(null,n.top-e.defaultTextHeight())},u[f[m+"Down"]="scrollLineDown"]=function(e){var n=e.getScrollInfo();if(!e.somethingSelected()){var t=e.lineAtHeight(n.top,"local")+1;e.getCursor().line<=t&&e.execCommand("goLineDown")}e.scrollTo(null,n.top+e.defaultTextHeight())},u[f["Shift-"+p+"L"]="splitSelectionByLine"]=function(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++)for(var o=n[r].from(),i=n[r].to(),a=o.line;a<=i.line;++a)i.line>o.line&&a==i.line&&0==i.ch||t.push({anchor:a==o.line?o:h(a,0),head:a==i.line?i:h(a)});e.setSelections(t,0)},f["Shift-Tab"]="indentLess",u[f.Esc="singleSelectionTop"]=function(e){var n=e.listSelections()[0];e.setSelection(n.anchor,n.head,{scroll:!1})},u[f[p+"L"]="selectLine"]=function(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++){var o=n[r];t.push({anchor:h(o.from().line,0),head:h(o.to().line+1,0)})}e.setSelections(t)},f["Shift-"+p+"K"]="deleteLine",u[f[p+"Enter"]="insertLineAfter"]=function(e){return r(e,!1)},u[f["Shift-"+p+"Enter"]="insertLineBefore"]=function(e){return r(e,!0)},u[f[p+"D"]="selectNextOccurrence"]=function(n){var t=n.getCursor("from"),r=n.getCursor("to"),i=n.state.sublimeFindFullWord==n.doc.sel;if(0==e.cmpPos(t,r)){var a=o(n,t);if(!a.word)return;n.setSelection(a.from,a.to),i=!0}else{var l=n.getRange(t,r),s=i?new RegExp("\\b"+l+"\\b"):l,c=n.getSearchCursor(s,r);c.findNext()?n.addSelection(c.from(),c.to()):(c=n.getSearchCursor(s,h(n.firstLine(),0)),c.findNext()&&n.addSelection(c.from(),c.to()))}i&&(n.state.sublimeFindFullWord=n.doc.sel)};var g="(){}[]";u[f["Shift-"+p+"Space"]="selectScope"]=function(e){i(e)||e.execCommand("selectAll")},u[f["Shift-"+p+"M"]="selectBetweenBrackets"]=function(n){return i(n)?void 0:e.Pass},u[f[p+"M"]="goToBracket"]=function(n){n.extendSelectionsBy(function(t){var r=n.scanForBracket(t.head,1);if(r&&0!=e.cmpPos(r.pos,t.head))return r.pos;var o=n.scanForBracket(t.head,-1);return o&&h(o.pos.line,o.pos.ch+1)||t.head})};var v=d?"Cmd-Ctrl-":"Shift-Ctrl-";u[f[v+"Up"]="swapLineUp"]=function(n){if(n.isReadOnly())return e.Pass;for(var t=n.listSelections(),r=[],o=n.firstLine()-1,i=[],a=0;a<t.length;a++){var l=t[a],s=l.from().line-1,c=l.to().line;i.push({anchor:h(l.anchor.line-1,l.anchor.ch),head:h(l.head.line-1,l.head.ch)}),0!=l.to().ch||l.empty()||--c,s>o?r.push(s,c):r.length&&(r[r.length-1]=c),o=c}n.operation(function(){for(var e=0;e<r.length;e+=2){var t=r[e],o=r[e+1],a=n.getLine(t);n.replaceRange("",h(t,0),h(t+1,0),"+swapLine"),o>n.lastLine()?n.replaceRange("\n"+a,h(n.lastLine()),null,"+swapLine"):n.replaceRange(a+"\n",h(o,0),null,"+swapLine")}n.setSelections(i),n.scrollIntoView()})},u[f[v+"Down"]="swapLineDown"]=function(n){if(n.isReadOnly())return e.Pass;for(var t=n.listSelections(),r=[],o=n.lastLine()+1,i=t.length-1;i>=0;i--){var a=t[i],l=a.to().line+1,s=a.from().line;0!=a.to().ch||a.empty()||l--,o>l?r.push(l,s):r.length&&(r[r.length-1]=s),o=s}n.operation(function(){for(var e=r.length-2;e>=0;e-=2){var t=r[e],o=r[e+1],i=n.getLine(t);t==n.lastLine()?n.replaceRange("",h(t-1),h(t),"+swapLine"):n.replaceRange("",h(t,0),h(t+1,0),"+swapLine"),n.replaceRange(i+"\n",h(o,0),null,"+swapLine")}n.scrollIntoView()})},u[f[p+"/"]="toggleCommentIndented"]=function(e){e.toggleComment({indent:!0})},u[f[p+"J"]="joinLines"]=function(e){for(var n=e.listSelections(),t=[],r=0;r<n.length;r++){for(var o=n[r],i=o.from(),a=i.line,l=o.to().line;r<n.length-1&&n[r+1].from().line==l;)l=n[++r].to().line;t.push({start:a,end:l,anchor:!o.empty()&&i})}e.operation(function(){for(var n=0,r=[],o=0;o<t.length;o++){for(var i,a=t[o],l=a.anchor&&h(a.anchor.line-n,a.anchor.ch),s=a.start;s<=a.end;s++){var c=s-n;s==a.end&&(i=h(c,e.getLine(c).length+1)),c<e.lastLine()&&(e.replaceRange(" ",h(c),h(c+1,/^\s*/.exec(e.getLine(c+1))[0].length)),++n)}r.push({anchor:l||i,head:i})}e.setSelections(r,0)})},u[f["Shift-"+p+"D"]="duplicateLine"]=function(e){e.operation(function(){for(var n=e.listSelections().length,t=0;n>t;t++){var r=e.listSelections()[t];r.empty()?e.replaceRange(e.getLine(r.head.line)+"\n",h(r.head.line,0)):e.replaceRange(e.getRange(r.from(),r.to()),r.from())}e.scrollIntoView()})},f[p+"T"]="transposeChars",u[f.F9="sortLines"]=function(e){a(e,!0)},u[f[p+"F9"]="sortLinesInsensitive"]=function(e){a(e,!1)},u[f.F2="nextBookmark"]=function(e){var n=e.state.sublimeBookmarks;if(n)for(;n.length;){var t=n.shift(),r=t.find();if(r)return n.push(t),e.setSelection(r.from,r.to)}},u[f["Shift-F2"]="prevBookmark"]=function(e){var n=e.state.sublimeBookmarks;if(n)for(;n.length;){n.unshift(n.pop());var t=n[n.length-1].find();if(t)return e.setSelection(t.from,t.to);n.pop()}},u[f[p+"F2"]="toggleBookmark"]=function(e){for(var n=e.listSelections(),t=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]),r=0;r<n.length;r++){for(var o=n[r].from(),i=n[r].to(),a=e.findMarks(o,i),l=0;l<a.length;l++)if(a[l].sublimeBookmark){a[l].clear();for(var s=0;s<t.length;s++)t[s]==a[l]&&t.splice(s--,1);break}l==a.length&&t.push(e.markText(o,i,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},u[f["Shift-"+p+"F2"]="clearBookmarks"]=function(e){var n=e.state.sublimeBookmarks;if(n)for(var t=0;t<n.length;t++)n[t].clear();n.length=0},u[f["Alt-F2"]="selectBookmarks"]=function(e){var n=e.state.sublimeBookmarks,t=[];if(n)for(var r=0;r<n.length;r++){var o=n[r].find();o?t.push({anchor:o.from,head:o.to}):n.splice(r--,0)}t.length&&e.setSelections(t,0)},f["Alt-Q"]="wrapLines";var S=p+"K ";f[S+p+"Backspace"]="delLineLeft",u[f.Backspace="smartBackspace"]=function(n){if(n.somethingSelected())return e.Pass;var t=n.getCursor(),r=n.getRange({line:t.line,ch:0},t),o=e.countColumn(r,null,n.getOption("tabSize")),i=n.getOption("indentUnit");if(r&&!/\S/.test(r)&&o%i==0){var a=new h(t.line,e.findColumn(r,o-i,i));return a.ch==t.ch?e.Pass:n.replaceRange("",a,t,"+delete")}return e.Pass},u[f[S+p+"K"]="delLineRight"]=function(e){e.operation(function(){for(var n=e.listSelections(),t=n.length-1;t>=0;t--)e.replaceRange("",n[t].anchor,h(n[t].to().line),"+delete");e.scrollIntoView()})},u[f[S+p+"U"]="upcaseAtCursor"]=function(e){l(e,function(e){return e.toUpperCase()})},u[f[S+p+"L"]="downcaseAtCursor"]=function(e){l(e,function(e){return e.toLowerCase()})},u[f[S+p+"Space"]="setSublimeMark"]=function(e){e.state.sublimeMark&&e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor())},u[f[S+p+"A"]="selectToSublimeMark"]=function(e){var n=e.state.sublimeMark&&e.state.sublimeMark.find();n&&e.setSelection(e.getCursor(),n)},u[f[S+p+"W"]="deleteToSublimeMark"]=function(n){var t=n.state.sublimeMark&&n.state.sublimeMark.find();if(t){var r=n.getCursor(),o=t;if(e.cmpPos(r,o)>0){var i=o;o=r,r=i}n.state.sublimeKilled=n.getRange(r,o),n.replaceRange("",r,o)}},u[f[S+p+"X"]="swapWithSublimeMark"]=function(e){var n=e.state.sublimeMark&&e.state.sublimeMark.find();n&&(e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor()),e.setCursor(n))},u[f[S+p+"Y"]="sublimeYank"]=function(e){null!=e.state.sublimeKilled&&e.replaceSelection(e.state.sublimeKilled,null,"paste")},f[S+p+"G"]="clearBookmarks",u[f[S+p+"C"]="showInCenter"]=function(e){var n=e.cursorCoords(null,"local");e.scrollTo(null,(n.top+n.bottom)/2-e.getScrollInfo().clientHeight/2)},u[f["Shift-Alt-Up"]="selectLinesUpward"]=function(e){e.operation(function(){for(var n=e.listSelections(),t=0;t<n.length;t++){var r=n[t];r.head.line>e.firstLine()&&e.addSelection(h(r.head.line-1,r.head.ch))}})},u[f["Shift-Alt-Down"]="selectLinesDownward"]=function(e){e.operation(function(){for(var n=e.listSelections(),t=0;t<n.length;t++){var r=n[t];r.head.line<e.lastLine()&&e.addSelection(h(r.head.line+1,r.head.ch))}})},u[f[p+"F3"]="findUnder"]=function(e){c(e,!0)},u[f["Shift-"+p+"F3"]="findUnderPrevious"]=function(e){c(e,!1)},u[f["Alt-F3"]="findAllUnder"]=function(e){var n=s(e);if(n){for(var t=e.getSearchCursor(n.query),r=[],o=-1;t.findNext();)r.push({anchor:t.from(),head:t.to()}),t.from().line<=n.from.line&&t.from().ch<=n.from.ch&&o++;e.setSelections(r,o)}},f["Shift-"+p+"["]="fold",f["Shift-"+p+"]"]="unfold",f[S+p+"0"]=f[S+p+"j"]="unfoldAll",f[p+"I"]="findIncremental",f["Shift-"+p+"I"]="findIncrementalReverse",f[p+"H"]="replace",f.F3="findNext",f["Shift-F3"]="findPrev",e.normalizeKeyMap(f)});